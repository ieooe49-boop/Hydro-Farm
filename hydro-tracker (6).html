<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydro Farm Tracker</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .main-menu {
            display: grid;
            gap: 15px;
        }
        
        .menu-btn {
            padding: 25px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            color: #333;
            transition: all 0.3s;
            text-align: left;
            min-height: 70px;
        }
        
        .menu-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .task-grid {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .task-btn {
            padding: 22px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            font-size: 17px;
            font-weight: 600;
            color: #333;
            transition: all 0.3s;
            text-align: left;
            min-height: 75px;
        }
        
        .task-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .task-frequency {
            font-size: 13px;
            color: #666;
            font-weight: normal;
            margin-top: 5px;
        }
        
        .unit-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .unit-btn {
            padding: 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            color: #333;
            transition: all 0.3s;
            min-height: 65px;
        }
        
        .unit-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .back-btn {
            width: 100%;
            padding: 15px;
            background: #999;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .submit-btn {
            width: 100%;
            padding: 18px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
        }
        
        .submit-btn:hover {
            background: #5568d3;
        }
        
        .export-btn {
            width: 100%;
            padding: 15px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .export-btn:hover {
            background: #45a049;
        }
        
        .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .radio-group {
            margin-bottom: 15px;
        }
        
        .radio-group > label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }
        
        .radio-options {
            display: flex;
            gap: 20px;
        }
        
        .radio-options label {
            font-weight: normal;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #333;
            font-size: 16px;
            cursor: pointer;
        }
        
        .radio-options input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .crop-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .crop-btn {
            padding: 18px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #333;
            transition: all 0.3s;
            font-size: 16px;
            min-height: 60px;
        }
        
        .crop-btn.selected {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }
        
        .success-message {
            background: #4caf50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .status-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }
        
        .status-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        
        .status-detail {
            font-size: 14px;
            color: #666;
            margin-bottom: 3px;
        }
        
        .overdue {
            color: #f44336;
            font-weight: 600;
        }
        
        .unit-header {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }
        
        .unit-header h2 {
            color: #2e7d32;
            margin-bottom: 5px;
        }
        
        .section-divider {
            margin: 25px 0 15px 0;
            padding-top: 15px;
            border-top: 2px solid #e0e0e0;
        }
        
        .section-header {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 12px;
        }
        
        .harvest-log {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .history-item {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .history-date {
            color: #666;
            font-size: 12px;
        }
        
        .suggested-task-item {
            background: #fff3cd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            cursor: pointer;
        }
        
        .suggested-task-item:hover {
            background: #ffe69c;
        }
        
        .suggested-task-title {
            font-weight: 600;
            color: #856404;
            margin-bottom: 4px;
        }
        
        .suggested-task-detail {
            font-size: 14px;
            color: #856404;
        }
        
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        
        .info-box p {
            color: #1565c0;
            font-size: 14px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üå± Hydro Farm Tracker</h1>
        <p class="subtitle">Track maintenance & harvests</p>
        
        <!-- MAIN MENU -->
        <div id="main-menu" class="screen active">
            <div class="main-menu">
                <button class="menu-btn" onclick="showScreen('task-select')">
                    ‚úÖ Do a Task
                </button>
                <button class="menu-btn" onclick="showScreen('suggested-tasks')">
                    üí° Suggested Tasks<br>
                    <span style="font-size: 13px; font-weight: normal; color: #666;">If you have time to help</span>
                </button>
                <button class="menu-btn" onclick="showScreen('unit-status-select')">
                    üìä View Unit Status
                </button>
                <button class="menu-btn" onclick="showScreen('harvest-log')">
                    üåø Harvest Log
                </button>
            </div>
        </div>
        
        <!-- SUGGESTED TASKS -->
        <div id="suggested-tasks" class="screen">
            <button class="back-btn" onclick="showScreen('main-menu')">‚Üê Back to Menu</button>
            
            <div class="info-box">
                <p><strong>üí° Helpful Suggestions</strong><br>
                These are tasks that could use attention. No pressure - only if you have time!</p>
            </div>
            
            <h2 style="margin-bottom: 20px; color: #333;">Tasks That Need Attention:</h2>
            <div id="suggested-tasks-list"></div>
        </div>
        
        <!-- TASK SELECT -->
        <div id="task-select" class="screen">
            <button class="back-btn" onclick="showScreen('main-menu')">‚Üê Back to Menu</button>
            <h2 style="margin-bottom: 20px; color: #333;">Select Task:</h2>
            <div class="task-grid">
                <button class="task-btn" onclick="selectTask('water-health')">
                    üíß Water Health & Nutrients
                    <div class="task-frequency">Daily - Whole Unit</div>
                </button>
                <button class="task-btn" onclick="selectTask('harvest')">
                    üåø Harvest
                    <div class="task-frequency">As Needed - Individual Sides</div>
                </button>
                <button class="task-btn" onclick="selectTask('filter-check')">
                    üîç Filter Check
                    <div class="task-frequency">Weekly - Whole Unit</div>
                </button>
                <button class="task-btn" onclick="selectTask('simple-clean')">
                    üßπ Simple Clean
                    <div class="task-frequency">Weekly - Whole Unit</div>
                </button>
                <button class="task-btn" onclick="selectTask('check-manifolds')">
                    üîß Check Manifolds
                    <div class="task-frequency">Weekly - Whole Unit</div>
                </button>
                <button class="task-btn" onclick="selectTask('full-restore')">
                    üîÑ Full Restore
                    <div class="task-frequency">Quarterly - Whole Unit</div>
                </button>
            </div>
        </div>
        
        <!-- UNIT SELECT FOR TASK -->
        <div id="unit-select" class="screen">
            <button class="back-btn" onclick="showScreen('task-select')">‚Üê Back to Tasks</button>
            <h2 style="margin-bottom: 15px; color: #333;" id="unit-select-title">Select Unit:</h2>
            <div class="unit-grid">
                <button class="unit-btn" onclick="selectUnit('agatha')">Agatha</button>
                <button class="unit-btn" onclick="selectUnit('bertha')">Bertha</button>
                <button class="unit-btn" onclick="selectUnit('carol')">Carol</button>
                <button class="unit-btn" onclick="selectUnit('dorothy')">Dorothy</button>
            </div>
        </div>
        
        <!-- SIDE SELECT (only for harvest) -->
        <div id="side-select" class="screen">
            <button class="back-btn" onclick="showScreen('unit-select')">‚Üê Back to Units</button>
            <h2 style="margin-bottom: 15px; color: #333;" id="side-select-title">Select Side:</h2>
            <div class="unit-grid">
                <button class="unit-btn" onclick="selectSide('1')">Side 1</button>
                <button class="unit-btn" onclick="selectSide('2')">Side 2</button>
            </div>
        </div>
        
        <!-- WATER HEALTH FORM -->
        <div id="water-health-form" class="screen">
            <button class="back-btn" onclick="showScreen('unit-select')">‚Üê Back</button>
            <div class="unit-header">
                <h2 id="wh-unit-name"></h2>
            </div>
            
            <h3 style="margin-bottom: 15px; color: #333;">üíß Water Health Check</h3>
            
            <div class="radio-group">
                <label>Was water added?</label>
                <div class="radio-options">
                    <label><input type="radio" name="waterAdded" value="yes"> Yes</label>
                    <label><input type="radio" name="waterAdded" value="no"> No</label>
                </div>
            </div>
            
            <div class="form-row">
                <input type="number" step="0.1" class="form-input" id="initialTDS" placeholder="Initial TDS (850-1200)">
                <input type="number" step="0.1" class="form-input" id="initialPH" placeholder="Initial pH (5.5-6.5)">
            </div>
            
            <div class="form-row">
                <input type="number" step="0.1" class="form-input" id="nutrientsAdded" placeholder="Tbs nutrients (0-3)">
                <input type="number" step="0.1" class="form-input" id="phDownAdded" placeholder="Tbs pH down (0-2)">
            </div>
            
            <div class="form-row">
                <input type="number" step="0.1" class="form-input" id="finalTDS" placeholder="Final TDS (850-1200)">
                <input type="number" step="0.1" class="form-input" id="finalPH" placeholder="Final pH (5.5-6.5)">
            </div>
            
            <textarea class="form-input" id="whNotes" placeholder="Notes (optional)" rows="3"></textarea>
            <input type="text" class="form-input" id="whVolunteer" placeholder="Your name">
            <button class="submit-btn" onclick="submitWaterHealth()">‚úì Submit</button>
            <div id="wh-success" style="display: none;"></div>
        </div>
        
        <!-- HARVEST FORM -->
        <div id="harvest-form" class="screen">
            <button class="back-btn" onclick="showScreen('side-select')">‚Üê Back</button>
            <div class="unit-header">
                <h2 id="harvest-unit-name"></h2>
            </div>
            
            <h3 style="margin-bottom: 15px; color: #333;">üåø Record Harvest</h3>
            
            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Select Crop:</label>
            <div class="crop-grid" id="crop-grid"></div>
            
            <input type="number" step="0.1" class="form-input" id="harvestAmount" placeholder="Amount in lbs (example: 2.5)">
            <input type="text" class="form-input" id="harvestVolunteer" placeholder="Your name">
            <button class="submit-btn" onclick="submitHarvest()">‚úì Log Harvest</button>
            <div id="harvest-success" style="display: none;"></div>
        </div>
        
        <!-- SIMPLE TASK FORM -->
        <div id="simple-task-form" class="screen">
            <button class="back-btn" onclick="showScreen('unit-select')">‚Üê Back</button>
            <div class="unit-header">
                <h2 id="simple-task-unit-name"></h2>
            </div>
            
            <h3 style="margin-bottom: 15px; color: #333;" id="simple-task-title"></h3>
            
            <input type="text" class="form-input" id="simpleTaskVolunteer" placeholder="Your name">
            <button class="submit-btn" onclick="submitSimpleTask()">‚úì Mark Complete</button>
            <div id="simple-task-success" style="display: none;"></div>
        </div>
        
        <!-- UNIT STATUS SELECT -->
        <div id="unit-status-select" class="screen">
            <button class="back-btn" onclick="showScreen('main-menu')">‚Üê Back to Menu</button>
            <h2 style="margin-bottom: 15px; color: #333;">Select Unit to View:</h2>
            
            <div class="unit-grid">
                <button class="unit-btn" onclick="viewUnitStatus('agatha')">Agatha</button>
                <button class="unit-btn" onclick="viewUnitStatus('bertha')">Bertha</button>
                <button class="unit-btn" onclick="viewUnitStatus('carol')">Carol</button>
                <button class="unit-btn" onclick="viewUnitStatus('dorothy')">Dorothy</button>
            </div>
        </div>
        
        <!-- UNIT STATUS DASHBOARD -->
        <div id="unit-status" class="screen">
            <button class="back-btn" onclick="showScreen('unit-status-select')">‚Üê Back</button>
            <div class="unit-header">
                <h2 id="status-unit-name"></h2>
            </div>
            <div id="status-content"></div>
        </div>
        
        <!-- HARVEST LOG -->
        <div id="harvest-log" class="screen">
            <button class="back-btn" onclick="showScreen('main-menu')">‚Üê Back to Menu</button>
            <h2 style="margin-bottom: 20px; color: #333;">Harvest Log</h2>
            <button class="export-btn" onclick="exportToExcel()">üìä Export to Excel</button>
            <div id="harvest-log-content"></div>
        </div>
    </div>

    <script>
        const units = {
            'agatha-whole': { name: 'Agatha', type: 'whole' },
            'agatha-1': { name: 'Agatha - Side 1', type: 'side' },
            'agatha-2': { name: 'Agatha - Side 2', type: 'side' },
            'bertha-whole': { name: 'Bertha', type: 'whole' },
            'bertha-1': { name: 'Bertha - Side 1', type: 'side' },
            'bertha-2': { name: 'Bertha - Side 2', type: 'side' },
            'carol-whole': { name: 'Carol', type: 'whole' },
            'carol-1': { name: 'Carol - Side 1', type: 'side' },
            'carol-2': { name: 'Carol - Side 2', type: 'side' },
            'dorothy-whole': { name: 'Dorothy', type: 'whole' },
            'dorothy-1': { name: 'Dorothy - Side 1', type: 'side' },
            'dorothy-2': { name: 'Dorothy - Side 2', type: 'side' }
        };

        const crops = ['Basil', 'Dill', 'Chives', 'Sage', 'Parsley'];
        
        let currentTask = null;
        let currentBaseUnit = null;
        let currentUnit = null;
        let selectedCrop = null;

        function loadData() {
            const saved = localStorage.getItem('hydroData');
            return saved ? JSON.parse(saved) : {};
        }

        function saveData(data) {
            localStorage.setItem('hydroData', JSON.stringify(data));
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            if (screenId === 'suggested-tasks') {
                renderSuggestedTasks();
            }
        }

        function renderSuggestedTasks() {
            const data = loadData();
            const suggestions = [];
            const now = Date.now();
            
            // Check all units for overdue tasks
            ['agatha', 'bertha', 'carol', 'dorothy'].forEach(baseUnit => {
                const wholeUnitId = baseUnit + '-whole';
                const unitData = data[wholeUnitId] || {};
                const unitName = baseUnit.charAt(0).toUpperCase() + baseUnit.slice(1);
                
                // Check water health (daily)
                if (!unitData['water-health']) {
                    suggestions.push({
                        unit: baseUnit,
                        unitName: unitName,
                        task: 'water-health',
                        title: `üíß ${unitName} - Water Health Check`,
                        detail: 'Never completed - should be done daily',
                        priority: 1
                    });
                } else {
                    const daysSince = Math.floor((now - unitData['water-health'].timestamp) / (1000 * 60 * 60 * 24));
                    if (daysSince >= 1) {
                        suggestions.push({
                            unit: baseUnit,
                            unitName: unitName,
                            task: 'water-health',
                            title: `üíß ${unitName} - Water Health Check`,
                            detail: `Last done ${daysSince} day${daysSince !== 1 ? 's' : ''} ago`,
                            priority: daysSince >= 2 ? 1 : 2
                        });
                    }
                }
                
                // Check weekly tasks
                const weeklyTasks = [
                    { id: 'filter-check', name: 'üîç Filter Check', interval: 7 },
                    { id: 'simple-clean', name: 'üßπ Simple Clean', interval: 7 },
                    { id: 'check-manifolds', name: 'üîß Check Manifolds', interval: 7 }
                ];
                
                weeklyTasks.forEach(task => {
                    if (!unitData[task.id]) {
                        suggestions.push({
                            unit: baseUnit,
                            unitName: unitName,
                            task: task.id,
                            title: `${task.name} - ${unitName}`,
                            detail: 'Never completed',
                            priority: 3
                        });
                    } else {
                        const daysSince = Math.floor((now - unitData[task.id].timestamp) / (1000 * 60 * 60 * 24));
                        if (daysSince > task.interval) {
                            suggestions.push({
                                unit: baseUnit,
                                unitName: unitName,
                                task: task.id,
                                title: `${task.name} - ${unitName}`,
                                detail: `Overdue by ${daysSince - task.interval} day${daysSince - task.interval !== 1 ? 's' : ''}`,
                                priority: 2
                            });
                        }
                    }
                });
                
                // Check quarterly tasks
                if (!unitData['full-restore']) {
                    suggestions.push({
                        unit: baseUnit,
                        unitName: unitName,
                        task: 'full-restore',
                        title: `üîÑ ${unitName} - Full Restore`,
                        detail: 'Never completed',
                        priority: 4
                    });
                } else {
                    const daysSince = Math.floor((now - unitData['full-restore'].timestamp) / (1000 * 60 * 60 * 24));
                    if (daysSince > 90) {
                        suggestions.push({
                            unit: baseUnit,
                            unitName: unitName,
                            task: 'full-restore',
                            title: `üîÑ ${unitName} - Full Restore`,
                            detail: `Overdue by ${daysSince - 90} day${daysSince - 90 !== 1 ? 's' : ''}`,
                            priority: 3
                        });
                    }
                }
            });
            
            // Sort by priority
            suggestions.sort((a, b) => a.priority - b.priority);
            
            const listEl = document.getElementById('suggested-tasks-list');
            if (suggestions.length === 0) {
                listEl.innerHTML = '<div class="info-box"><p>‚úÖ All tasks are up to date! Great work!</p></div>';
            } else {
                listEl.innerHTML = suggestions.map(s => `
                    <div class="suggested-task-item" onclick="quickStartTask('${s.task}', '${s.unit}')">
                        <div class="suggested-task-title">${s.title}</div>
                        <div class="suggested-task-detail">${s.detail} - Tap to start</div>
                    </div>
                `).join('');
            }
        }

        function quickStartTask(taskId, baseUnit) {
            currentTask = taskId;
            currentBaseUnit = baseUnit;
            currentUnit = baseUnit + '-whole';
            
            if (taskId === 'water-health') {
                document.getElementById('wh-unit-name').textContent = units[currentUnit].name;
                showScreen('water-health-form');
            } else {
                const taskNames = {
                    'filter-check': 'üîç Filter Check',
                    'simple-clean': 'üßπ Simple Clean',
                    'check-manifolds': 'üîß Check Manifolds',
                    'full-restore': 'üîÑ Full Restore'
                };
                document.getElementById('simple-task-unit-name').textContent = units[currentUnit].name;
                document.getElementById('simple-task-title').textContent = taskNames[taskId];
                showScreen('simple-task-form');
            }
        }

        function selectTask(task) {
            currentTask = task;
            showScreen('unit-select');
        }

        function selectUnit(baseUnit) {
            currentBaseUnit = baseUnit;
            
            if (currentTask === 'harvest') {
                document.getElementById('side-select-title').textContent = `Select ${baseUnit.charAt(0).toUpperCase() + baseUnit.slice(1)} Side:`;
                showScreen('side-select');
            } else {
                currentUnit = baseUnit + '-whole';
                
                if (currentTask === 'water-health') {
                    document.getElementById('wh-unit-name').textContent = units[currentUnit].name;
                    showScreen('water-health-form');
                } else {
                    const taskNames = {
                        'filter-check': 'üîç Filter Check',
                        'simple-clean': 'üßπ Simple Clean',
                        'check-manifolds': 'üîß Check Manifolds',
                        'full-restore': 'üîÑ Full Restore'
                    };
                    document.getElementById('simple-task-unit-name').textContent = units[currentUnit].name;
                    document.getElementById('simple-task-title').textContent = taskNames[currentTask];
                    showScreen('simple-task-form');
                }
            }
        }

        function selectSide(side) {
            currentUnit = currentBaseUnit + '-' + side;
            
            document.getElementById('harvest-unit-name').textContent = units[currentUnit].name;
            const cropGrid = document.getElementById('crop-grid');
            cropGrid.innerHTML = '';
            selectedCrop = null;
            crops.forEach(crop => {
                const btn = document.createElement('button');
                btn.className = 'crop-btn';
                btn.textContent = crop;
                btn.onclick = () => {
                    selectedCrop = crop;
                    document.querySelectorAll('.crop-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                };
                cropGrid.appendChild(btn);
            });
            showScreen('harvest-form');
        }

        function submitWaterHealth() {
            const waterAdded = document.querySelector('input[name="waterAdded"]:checked');
            const volunteer = document.getElementById('whVolunteer').value.trim();
            
            if (!waterAdded || !volunteer) {
                alert('Please fill in required fields');
                return;
            }
            
            const data = loadData();
            if (!data[currentUnit]) data[currentUnit] = {};
            
            const timestamp = Date.now();
            const waterHealthData = {
                waterAdded: waterAdded.value === 'yes',
                initialTDS: document.getElementById('initialTDS').value || null,
                initialPH: document.getElementById('initialPH').value || null,
                nutrientsAdded: document.getElementById('nutrientsAdded').value || null,
                phDownAdded: document.getElementById('phDownAdded').value || null,
                finalTDS: document.getElementById('finalTDS').value || null,
                finalPH: document.getElementById('finalPH').value || null,
                notes: document.getElementById('whNotes').value.trim(),
                volunteer: volunteer,
                timestamp: timestamp
            };
            
            data[currentUnit]['water-health'] = waterHealthData;
            saveData(data);
            
            const msg = document.getElementById('wh-success');
            msg.className = 'success-message';
            msg.textContent = `‚úì Water Health Check completed by ${volunteer}`;
            msg.style.display = 'block';
            
            document.querySelectorAll('#water-health-form input, #water-health-form textarea').forEach(el => el.value = '');
            document.querySelectorAll('input[name="waterAdded"]').forEach(el => el.checked = false);
            
            setTimeout(() => showScreen('main-menu'), 2000);
        }

        function submitHarvest() {
            if (!selectedCrop) {
                alert('Please select a crop');
                return;
            }
            
            const amount = parseFloat(document.getElementById('harvestAmount').value);
            const volunteer = document.getElementById('harvestVolunteer').value.trim();
            
            if (!amount || !volunteer) {
                alert('Please fill in all fields');
                return;
            }
            
            const data = loadData();
            if (!data.harvests) data.harvests = [];
            
            data.harvests.push({
                unit: currentUnit,
                unitName: units[currentUnit].name,
                crop: selectedCrop,
                amount: amount,
                volunteer: volunteer,
                timestamp: Date.now()
            });
            
            saveData(data);
            
            const msg = document.getElementById('harvest-success');
            msg.className = 'success-message';
            msg.textContent = `‚úì Logged ${amount} lbs of ${selectedCrop}`;
            msg.style.display = 'block';
            
            document.getElementById('harvestAmount').value = '';
            document.getElementById('harvestVolunteer').value = '';
            selectedCrop = null;
            
            setTimeout(() => showScreen('main-menu'), 2000);
        }

        function submitSimpleTask() {
            const volunteer = document.getElementById('simpleTaskVolunteer').value.trim();
            
            if (!volunteer) {
                alert('Please enter your name');
                return;
            }
            
            const data = loadData();
            if (!data[currentUnit]) data[currentUnit] = {};
            
            data[currentUnit][currentTask] = {
                volunteer: volunteer,
                timestamp: Date.now()
            };
            
            saveData(data);
            
            const msg = document.getElementById('simple-task-success');
            msg.className = 'success-message';
            msg.textContent = `‚úì Task completed by ${volunteer}`;
            msg.style.display = 'block';
            
            document.getElementById('simpleTaskVolunteer').value = '';
            
            setTimeout(() => showScreen('main-menu'), 2000);
        }

        function viewUnitStatus(baseUnit) {
            const wholeUnitId = baseUnit + '-whole';
            const side1Id = baseUnit + '-1';
            const side2Id = baseUnit + '-2';
            
            const data = loadData();
            const wholeData = data[wholeUnitId] || {};
            
            document.getElementById('status-unit-name').textContent = baseUnit.charAt(0).toUpperCase() + baseUnit.slice(1);
            
            let html = '<h3 class="section-header">Whole Unit Status</h3>';
            
            // Water Health
            if (wholeData['water-health']) {
                const wh = wholeData['water-health'];
                const daysSince = Math.floor((Date.now() - wh.timestamp) / (1000 * 60 * 60 * 24));
                html += `
                    <div class="status-card">
                        <div class="status-title">üíß Water Health & Nutrients</div>
                        <div class="status-detail">Last checked: ${daysSince} day${daysSince !== 1 ? 's' : ''} ago by ${wh.volunteer}</div>
                        <div class="status-detail">Most Recent TDS: ${wh.finalTDS || wh.initialTDS || 'N/A'}</div>
                        <div class="status-detail">Most Recent pH: ${wh.finalPH || wh.initialPH || 'N/A'}</div>
                    </div>
                `;
            } else {
                html += `
                    <div class="status-card">
                        <div class="status-title">üíß Water Health & Nutrients</div>
                        <div class="status-detail overdue">Never completed</div>
                    </div>
                `;
            }
            
            // Other whole unit tasks
            const tasks = [
                { id: 'filter-check', name: 'üîç Filter Check', interval: 7 },
                { id: 'simple-clean', name: 'üßπ Simple Clean', interval: 7 },
                { id: 'check-manifolds', name: 'üîß Check Manifolds', interval: 7 },
                { id: 'full-restore', name: 'üîÑ Full Restore', interval: 90 }
            ];
            
            tasks.forEach(task => {
                if (wholeData[task.id]) {
                    const daysSince = Math.floor((Date.now() - wholeData[task.id].timestamp) / (1000 * 60 * 60 * 24));
                    const isOverdue = daysSince > task.interval;
                    html += `
                        <div class="status-card">
                            <div class="status-title">${task.name}</div>
                            <div class="status-detail ${isOverdue ? 'overdue' : ''}">
                                Last done: ${daysSince} day${daysSince !== 1 ? 's' : ''} ago by ${wholeData[task.id].volunteer}
                                ${isOverdue ? ' ‚ö†Ô∏è OVERDUE' : ''}
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="status-card">
                            <div class="status-title">${task.name}</div>
                            <div class="status-detail overdue">Never completed</div>
                        </div>
                    `;
                }
            });
            
            // Side 1 Harvests
            html += '<div class="section-divider"><h3 class="section-header">Side 1 Harvests</h3></div>';
            const side1Harvests = (data.harvests || []).filter(h => h.unit === side1Id).slice(0, 5);
            if (side1Harvests.length > 0) {
                html += '<div class="status-card"><div class="status-title">üåø Recent Harvests</div><div class="harvest-log">';
                side1Harvests.forEach(h => {
                    const date = new Date(h.timestamp);
                    html += `<div class="status-detail">${h.amount} lbs ${h.crop} - ${h.volunteer} (${date.toLocaleDateString()})</div>`;
                });
                html += '</div></div>';
            } else {
                html += '<div class="status-card"><div class="status-title">üåø Recent Harvests</div><div class="status-detail">No harvests recorded</div></div>';
            }
            
            // Side 2 Harvests
            html += '<div class="section-divider"><h3 class="section-header">Side 2 Harvests</h3></div>';
            const side2Harvests = (data.harvests || []).filter(h => h.unit === side2Id).slice(0, 5);
            if (side2Harvests.length > 0) {
                html += '<div class="status-card"><div class="status-title">üåø Recent Harvests</div><div class="harvest-log">';
                side2Harvests.forEach(h => {
                    const date = new Date(h.timestamp);
                    html += `<div class="status-detail">${h.amount} lbs ${h.crop} - ${h.volunteer} (${date.toLocaleDateString()})</div>`;
                });
                html += '</div></div>';
            } else {
                html += '<div class="status-card"><div class="status-title">üåø Recent Harvests</div><div class="status-detail">No harvests recorded</div></div>';
            }
            
            document.getElementById('status-content').innerHTML = html;
            showScreen('unit-status');
        }

        function renderHarvestLog() {
            const data = loadData();
            const harvests = (data.harvests || []).slice(0, 50);
            
            if (harvests.length === 0) {
                document.getElementById('harvest-log-content').innerHTML = '<p style="color: #999;">No harvests recorded yet</p>';
                return;
            }
            
            let html = '';
            harvests.forEach(h => {
                const date = new Date(h.timestamp);
                html += `
                    <div class="history-item">
                        <div><strong>${h.volunteer}</strong> - ${h.amount} lbs of ${h.crop} from ${h.unitName}</div>
                        <div class="history-date">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>
                    </div>
                `;
            });
            
            document.getElementById('harvest-log-content').innerHTML = html;
        }

        function exportToExcel() {
            const data = loadData();
            const harvests = data.harvests || [];
            
            if (harvests.length === 0) {
                alert('No harvest data to export');
                return;
            }
            
            // Prepare data for Excel
            const excelData = harvests.map(h => {
                const date = new Date(h.timestamp);
                return {
                    'Date': date.toLocaleDateString(),
                    'Time': date.toLocaleTimeString(),
                    'Unit': h.unitName,
                    'Crop': h.crop,
                    'Amount (lbs)': h.amount,
                    'Volunteer': h.volunteer
                };
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Harvest Data');
            
            // Generate filename with current date
            const today = new Date().toISOString().split('T')[0];
            const filename = `Hydro_Harvest_Data_${today}.xlsx`;
            
            // Download file
            XLSX.writeFile(wb, filename);
        }
        
        const observer = new MutationObserver(() => {
            if (document.getElementById('harvest-log').classList.contains('active')) {
                renderHarvestLog();
            }
        });
        observer.observe(document.getElementById('harvest-log'), { attributes: true });
    </script>
</body>
</html>
